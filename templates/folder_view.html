{% extends "base.html" %}
{% set previewable_exts = ['png','jpg','jpeg','gif','mp4','ogg','webm','txt','mov','m4v'] %}
{% set max_upload_size = 5 %} {# æœ€å¤§ä¸Šä¼ å¤§å°ï¼Œå•ä½ GBï¼Œå¯æ ¹æ®åå°é…ç½®è°ƒæ•´ #}
{% block content %}
<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3">
  {% if search_query %}
    <a href="{{ url_for('folder_view', parent_id='root', view=view_mode) }}" class="btn btn-secondary mb-2 mb-md-0">
      ğŸ  è¿”å›æ ¹ç›®å½•
    </a>
  {% else %}
    <div class="d-flex flex-column flex-sm-row mb-2 mb-md-0 gap-2">
      <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#newFolderModal">
        ğŸ“ æ–°å»ºæ–‡ä»¶å¤¹
      </button>
      <button class="btn btn-primary" id="uploadBtn">
        ğŸ“¤ ä¸Šä¼ æ–‡ä»¶
      </button>
      <input type="file" id="fileInput" multiple style="display:none">
      {% if breadcrumbs|length > 1 %}
        <a href="{{ url_for('folder_view', parent_id=breadcrumbs[-2].id, view=view_mode) }}" class="btn btn-secondary">
          ğŸ”™ è¿”å›ä¸Šçº§ç›®å½•
        </a>
      {% endif %}
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary" id="listViewBtn">åˆ—è¡¨</button>
      <button class="btn btn-outline-secondary" id="gridViewBtn">å¹³é“º</button>
    </div>
  {% endif %}
</div>

{% if view_mode == 'list' %}
<div class="table-responsive">
  <table class="table table-hover">
    <thead>
      <tr>
        <th>åç§°</th>
        <th class="d-none d-md-table-cell">ç±»å‹</th>
        <th class="d-none d-lg-table-cell">ä¸Šä¼ æ—¶é—´</th>
        <th class="d-none d-lg-table-cell">å¤§å°</th>
        <th class="d-none d-lg-table-cell">ä½ç½®</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody>
      {% for item in items %}
      <tr>
        <td>
          {% if item.is_folder %}
            <a href="{{ url_for('folder_view', parent_id=item.id, view=view_mode) }}">ğŸ“ {{ item.name }}</a>
          {% else %}
            {% set ext = item.name.split('.')[-1].lower() %}
            {% if ext in ['png','jpg','jpeg','gif'] %}ğŸ–¼ï¸
            {% elif ext in ['mp4','ogg','webm','mov','m4v'] %}ğŸï¸
            {% else %}ğŸ“„{% endif %}
            {{ item.name }}
          {% endif %}
        </td>
        <td class="d-none d-md-table-cell">{{ 'æ–‡ä»¶å¤¹' if item.is_folder else 'æ–‡ä»¶' }}</td>
        <td class="d-none d-lg-table-cell">{{ item.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
        <td class="d-none d-lg-table-cell">{{ item.size }}</td>
        <td class="d-none d-lg-table-cell">{{ item.path }}</td>
        <td>
          <button class="btn btn-sm btn-secondary me-1" onclick="renamePrompt({{ item.id }}, '{{ item.name }}')">âœï¸</button>
          <button class="btn btn-sm btn-danger me-1" onclick="showFirstConfirm({{ item.id }}, '{{ item.name }}')">ğŸ—‘ï¸</button>
          {% if not item.is_folder %}
          <a href="{{ url_for('download', file_id=item.id) }}" class="btn btn-sm btn-success me-1">â¬‡ï¸</a>
          {% if ext in previewable_exts %}
          <a href="{{ url_for('preview', file_id=item.id) }}" class="btn btn-sm btn-info" target="_blank">ğŸ‘ï¸</a>
          {% endif %}
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<div class="grid-container">
  {% for item in items %}
  <div class="grid-item text-center">
    {% if item.is_folder %}
      <a href="{{ url_for('folder_view', parent_id=item.id, view=view_mode) }}">
        <div>ğŸ“</div><div>{{ item.name }}</div>
      </a>
    {% else %}
      {% set ext = item.name.split('.')[-1].lower() %}
      {% if ext in ['png','jpg','jpeg','gif'] %}
        <a href="{{ url_for('preview', file_id=item.id) }}" target="_blank">
          <img src="{{ url_for('preview', file_id=item.id) }}" class="thumb"><div>{{ item.name }}</div>
        </a>
      {% elif ext in ['mp4','ogg','webm'] %}
        <a href="{{ url_for('preview', file_id=item.id) }}" target="_blank">
          <video class="thumb" muted><source src="{{ url_for('preview', file_id=item.id) }}"></video><div>{{ item.name }}</div>
        </a>
      {% else %}
        <a href="{{ url_for('preview', file_id=item.id) }}" target="_blank">
          <div>ğŸ“„</div><div>{{ item.name }}</div>
        </a>
      {% endif %}
    {% endif %}
    <div class="mt-1 d-flex justify-content-center gap-1">
      <button class="btn btn-sm btn-secondary" onclick="renamePrompt({{ item.id }}, '{{ item.name }}')">âœï¸</button>
      <button class="btn btn-sm btn-danger" onclick="showFirstConfirm({{ item.id }}, '{{ item.name }}')">ğŸ—‘ï¸</button>
      {% if not item.is_folder %}
      <a href="{{ url_for('download', file_id=item.id) }}" class="btn btn-sm btn-success">â¬‡ï¸</a>
      {% endif %}
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}

<!-- æ–°å»ºæ–‡ä»¶å¤¹ Modal -->
<div class="modal fade" id="newFolderModal" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content">
      <form method="post" action="{{ url_for('new_folder') }}">
        <div class="modal-header">
          <h5 class="modal-title">æ–°å»ºæ–‡ä»¶å¤¹</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input name="folder_name" class="form-control" placeholder="æ–‡ä»¶å¤¹åç§°" required>
          <input type="hidden" name="parent_id" value="{{ parent_id }}">
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button class="btn btn-primary">åˆ›å»º</button>
        </div>
      </form>
  </div></div>
</div>

<!-- ä¸Šä¼ æ–‡ä»¶ Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
  <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="uploadModalLabel">ä¸Šä¼ æ–‡ä»¶</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="å…³é—­"></button>
      </div>
      <div class="modal-body">
        <p>æœ€å¤§åªèƒ½ä¸Šä¼  {{ max_upload_size }}G çš„æ–‡ä»¶ã€‚</p>
        <p>è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶ã€‚</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button type="button" class="btn btn-primary" id="triggerFileInputBtn">å»ä¸Šä¼ æ–‡ä»¶</button>
      </div>
  </div></div>
</div>

<!-- ä¸Šä¼ è¿›åº¦ Modal -->
<div class="modal fade" id="uploadProgressModal" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ä¸Šä¼ è¿›åº¦</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="progress">
          <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
        </div>
      </div>
  </div></div>
</div>

<!-- ä¸Šä¼ å®Œæˆ Modal -->
<div class="modal fade" id="uploadSuccessModal" tabindex="-1" aria-labelledby="uploadSuccessModalLabel" aria-hidden="true">
  <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="uploadSuccessModalLabel">ä¸Šä¼ å®Œæˆ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">æ–‡ä»¶ä¸Šä¼ å·²æˆåŠŸå®Œæˆï¼</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="location.reload()">ç¡®å®š</button>
      </div>
  </div></div>
</div>

<!-- é‡å‘½å Modal -->
<div class="modal fade" id="renameModal" tabindex="-1" aria-labelledby="renameModalLabel" aria-hidden="true">
  <div class="modal-dialog"><div class="modal-content">
    <form method="post" action="{{ url_for('rename') }}">
      <div class="modal-header">
        <h5 class="modal-title" id="renameModalLabel">é‡å‘½å</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="å…³é—­"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="renameInput" class="form-label">æ–°åç§°</label>
          <input type="text" class="form-control" id="renameInput" name="new_name" required>
        </div>
        <input type="hidden" id="renameFileId" name="file_id">
        <input type="hidden" name="parent_id" value="{{ parent_id }}">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button type="submit" class="btn btn-primary">ç¡®å®š</button>
      </div>
    </form>
  </div></div>
</div>

<!-- ç¬¬ä¸€æ¬¡ç¡®è®¤ Modal -->
<div class="modal fade" id="firstConfirmModal" tabindex="-1" aria-labelledby="firstConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">åˆ é™¤ç¡®è®¤</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="å…³é—­"></button>
      </div>
      <div class="modal-body"><p>æ‚¨ç¡®å®šè¦åˆ é™¤ "<span id="fileNameFirst"></span>" å—ï¼Ÿ</p></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button type="button" class="btn btn-danger" id="toSecondConfirmBtn">ç¡®è®¤</button>
      </div>
  </div></div>
</div>

<!-- ç¬¬äºŒæ¬¡ç¡®è®¤ Modal -->
<div class="modal fade" id="secondConfirmModal" tabindex="-1" aria-labelledby="secondConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog"><div class="modal-content border-danger">
      <div class="modal-header">
        <h5 class="modal-title text-danger">âš ï¸ å†æ¬¡ç¡®è®¤åˆ é™¤</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="å…³é—­"></button>
      </div>
      <div class="modal-body">
        <p class="text-danger">æ­¤æ“ä½œå°† <strong>æ°¸ä¹…åˆ é™¤</strong> "<span id="fileNameSecond"></span>"ï¼Œæ— æ³•æ¢å¤ï¼</p>
        <p>æ˜¯å¦ç»§ç»­ï¼Ÿ</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button type="button" class="btn btn-danger" id="confirmFinalDeleteBtn">ç¡®è®¤åˆ é™¤</button>
      </div>
  </div></div>
</div>

<script>
// é‡å‘½åæ“ä½œ
function renamePrompt(id, oldName) {
  // å¡«å……éšè—åŸŸä¸è¾“å…¥æ¡†
  document.getElementById('renameFileId').value = id;
  document.getElementById('renameInput').value = oldName;
  // å¼¹å‡º Modal
  new bootstrap.Modal(document.getElementById('renameModal')).show();
}

// åˆ‡æ¢è§†å›¾æ¨¡å¼
function changeView(mode) {
  const params = new URLSearchParams(window.location.search);
  params.set('view', mode);
  window.location.search = params.toString();
}

// æ˜¾ç¤ºä¸Šä¼ æ–‡ä»¶ Modal
document.getElementById('uploadBtn')?.addEventListener('click', function() {
  new bootstrap.Modal(document.getElementById('uploadModal')).show();
});

// è§¦å‘æ–‡ä»¶é€‰æ‹©
document.getElementById('triggerFileInputBtn')?.addEventListener('click', function() {
  document.getElementById('fileInput').click();
  bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
});

// æ–‡ä»¶é€‰æ‹©å¹¶ä¸Šä¼ 
document.getElementById('fileInput')?.addEventListener('change', function () {
  const maxTotalSize = 5 * 1024 * 1024 * 1024; // 5GB
  const files = this.files;
  let totalSize = 0;

  for (let f of files) {
    totalSize += f.size;
  }

  if (totalSize > maxTotalSize) {
    alert("æ‚¨é€‰æ‹©çš„æ–‡ä»¶æ€»å¤§å°è¶…è¿‡ 5GBï¼Œæ— æ³•ä¸Šä¼ ï¼Œè¯·é‡æ–°é€‰æ‹©ã€‚");
    this.value = ''; // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
    return;
  }

  const fd = new FormData();
  for (let f of files) fd.append('files', f);
  fd.append('parent_id', '{{ parent_id }}');

  // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦æ¡å¼¹çª—
  new bootstrap.Modal(document.getElementById('uploadProgressModal')).show();

  const xhr = new XMLHttpRequest();
  xhr.open('POST', '{{ url_for("upload") }}');

  xhr.upload.onprogress = function(e) {
    if (e.lengthComputable) {
      const percent = Math.floor((e.loaded / e.total) * 100);
      document.getElementById('uploadProgressBar').style.width = percent + '%';
    }
  };

  xhr.onload = function() {
    if (xhr.status === 200) {
      new bootstrap.Modal(document.getElementById('uploadProgressModal')).hide();
      new bootstrap.Modal(document.getElementById('uploadSuccessModal')).show();
    } else {
      alert('ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
    }
  };

  xhr.send(fd);
});

// åˆ‡æ¢åˆ—è¡¨/å¹³é“ºè§†å›¾
document.getElementById('listViewBtn')?.addEventListener('click', function() { changeView('list'); });
document.getElementById('gridViewBtn')?.addEventListener('click', function() { changeView('grid'); });

let deleteTargetId = null;
let deleteTargetName = "";
// ç¬¬ä¸€æ¬¡å¼¹çª—
function showFirstConfirm(fileId, fileName) {
  deleteTargetId = fileId;
  deleteTargetName = fileName;

  document.getElementById('fileNameFirst').textContent = fileName;

  const firstModal = new bootstrap.Modal(document.getElementById('firstConfirmModal'));
  firstModal.show();

  document.getElementById('toSecondConfirmBtn').onclick = function () {
    firstModal.hide();
    showSecondConfirm();
  };
}

// ç¬¬äºŒæ¬¡å¼¹çª—
function showSecondConfirm() {
  document.getElementById('fileNameSecond').textContent = deleteTargetName;

  const secondModal = new bootstrap.Modal(document.getElementById('secondConfirmModal'));
  secondModal.show();

  document.getElementById('confirmFinalDeleteBtn').onclick = function () {
    deleteFile(deleteTargetId);
  };
}

// æ‰§è¡Œåˆ é™¤è¯·æ±‚
function deleteFile(fileId) {
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = '{{ url_for("delete") }}';

  const fileInput = document.createElement('input');
  fileInput.type = 'hidden';
  fileInput.name = 'file_id';
  fileInput.value = fileId;

  const parentInput = document.createElement('input');
  parentInput.type = 'hidden';
  parentInput.name = 'parent_id';
  parentInput.value = '{{ parent_id }}';

  form.appendChild(fileInput);
  form.appendChild(parentInput);

  document.body.appendChild(form);
  form.submit();
}
</script>
{% endblock %}

